<!DOCTYPE html>
<html>
<head>
    <title>스마트그리드 실시간 모니터링</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" type="text/css">
    <!-- <link href="/static/style.css" rel="stylesheet" type="text/css"> -->
</head>
<body>
    <h2>실시간 전력 모니터링</h2>
    <div class="relay-control">
        <button onclick="toggleRelay()">릴레이 토글</button>
        <p id="relay-status">릴레이 상태: </p>
    </div>

    <div class="box">
        <canvas id="powerChart" style="display: flex;"></canvas>
        <canvas id="currentChart"></canvas>
        <canvas id="voltageChart"></canvas>
    </div>

    <script>
        const socket = io();

        const labels = [];
        const maxPoints = 60;

        function createChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        fill: false
                    }]
                },
                options: {
                    animation: false,
                    responsive: false,
                    scales: {
                        x: {
                            display: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        const currentChart = createChart(document.getElementById('currentChart'), '전류 (A)', 'red');
        const voltageChart = createChart(document.getElementById('voltageChart'), '전압 (V)', 'green');
        const powerChart = createChart(document.getElementById('powerChart'), 'power (W)', 'blue');

        socket.on('sensor_data', function(data) {
            const now = new Date();
            const label = now.toLocaleTimeString()

            if (labels.length >= maxPoints) {
                labels.shift();
            }
            labels.push(label);

            function updateChart(chart, value) {
                const data = chart.data.datasets[0].data;
                if (data.length >= maxPoints) data.shift();
                data.push(value);
                chart.update();
            }

            updateChart(currentChart, data.current);
            updateChart(voltageChart, data.voltage);
            updateChart(powerChart, data.power);

            function toggleRelay() {
                socket.emit('toggle_relay');
            }

            socket.on('relay_status', function(status) {
                document.getElementById('relay-status').innerText = '릴레이 상태: ' + (status ? 'ON' : 'OFF');
            });

            window.addEventListener('resize', () => {
                powerChart.resize();
                currentChart.resize();
                voltageChart.resize();
            });
        });
    </script>
</body>
</html>
