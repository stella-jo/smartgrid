<!DOCTYPE html>
<html>
<head>
    <title>스마트그리드 실시간 모니터링</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" type="text/css">
    <!-- <link href="/static/style.css" rel="stylesheet" type="text/css"> -->
</head>
<body>
    <h2>실시간 전력 모니터링</h2>
    <div class="box">
        <canvas id="powerChart" style="display: flex;"></canvas>
        <canvas id="currentChart"></canvas>
        <canvas id="voltageChart"></canvas>
    </div>

    <script>
        const socket = io();

        const labels = [];
        const maxPoints = 60;

        const powerData = [];
        const predictedData = [];

        const ctx = document.getElementById('powerChart').getContext('2d');

        const powerChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'power (W)',
                        data: powerData,
                        borderColor: 'blue',
                        fill: false,
                        tension: 0.2
                    },
                    {
                        label: 'predicted power (W)',
                        data: predictedData,
                        borderColor: 'orange',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.2
                    }
                ]
            },
            options: {
                animation: false,
                responsive: false,
                scales: {
                    x: {
                        display: true
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                maintainAspectRatio: false
            }
        });

        function createChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        fill: false
                    }]
                },
                options: {
                    animation: false,
                    responsive: false,
                    scales: {
                        x: {
                            display: true
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        const currentChart = createChart(document.getElementById('currentChart'), '전류 (A)', 'red');
        const voltageChart = createChart(document.getElementById('voltageChart'), '전압 (V)', 'green');

        socket.on('sensor_data', function(data) {
            const now = new Date();
            const label = now.toLocaleTimeString
            const futureLabel = new Date(now.getTime() + 30 * 1000)

            if (labels.length >= maxPoints) {
                labels.shift();
                powerData.shift();
                predictedData.shift();
            }
            labels.push(label);

            powerData.push(data.power);
            if (data.predicted_power !== null) {
                predictedData.push({
                    x: futureTime.toLocaleTimeString(),  // 여기만 쓰면 정렬이 깨질 수 있음
                    y: data.predicted_power
                });
            }
            powerChart.update();

            function updateChart(chart, value) {
                const data = chart.data.datasets[0].data;
                if (data.length >= maxPoints) data.shift();
                data.push(value);
                chart.update();
            }

            updateChart(currentChart, data.current);
            updateChart(voltageChart, data.voltage);

            window.addEventListener('resize', () => { powerChart.resize(); });
            window.addEventListener('resize', () => { currentChart.resize(); });
            window.addEventListener('resize', () => { voltageChart.resize(); });
        });
    </script>
</body>
</html>
